<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mia Pro - Auto Fix</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Noto+Sans+Sinhala:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #121212; --chat-bg: #1E1E1E; --primary: #8B5CF6; --user-msg: #7C3AED; --ai-msg: #374151; --text: #F3F4F6; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Inter', 'Noto Sans Sinhala', sans-serif; margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        .app-container { width: 100%; max-width: 500px; display: flex; flex-direction: column; background: var(--chat-bg); height: 100%; position: relative; }
        .header { padding: 15px 20px; background: rgba(0,0,0,0.3); display: flex; align-items: center; gap: 15px; border-bottom: 1px solid #333; z-index: 10; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
        .info h2 { margin: 0; font-size: 1.1rem; }
        .info p { margin: 0; font-size: 0.8rem; color: #9CA3AF; }
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .msg.ai { align-self: flex-start; background: var(--ai-msg); border-bottom-left-radius: 4px; }
        .msg.user { align-self: flex-end; background: var(--user-msg); border-bottom-right-radius: 4px; }
        .msg.system { align-self: center; background: transparent; color: #6B7280; font-size: 0.8rem; border: 1px solid #374151; }
        .msg.error { align-self: center; background: #991B1B; color: white; text-align: center; }
        .input-area { padding: 15px; background: rgba(0,0,0,0.3); display: flex; gap: 10px; align-items: center; }
        input { flex: 1; padding: 12px 15px; border-radius: 25px; border: 1px solid #444; background: #2A2A2A; color: white; outline: none; }
        button { background: var(--primary); border: none; width: 45px; height: 45px; border-radius: 50%; color: white; cursor: pointer; }
        
        /* SETUP SCREEN */
        .setup-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; }
        .hidden { display: none !important; }
        .setup-box { background: #2D2D2D; padding: 30px; border-radius: 20px; text-align: center; width: 80%; }
        .upload-btn { background: var(--primary); padding: 10px 20px; border-radius: 10px; color: white; cursor: pointer; margin-top: 15px; display: inline-block; }
    </style>
</head>
<body>

    <div id="setupScreen" class="setup-overlay hidden">
        <div class="setup-box">
            <h2>One Last Step!</h2>
            <p>Select your <b>mia.jpg</b> photo to start.</p>
            <input type="file" id="setupInput" accept="image/*" style="display:none">
            <div class="upload-btn" onclick="document.getElementById('setupInput').click()">üìÇ Select Photo</div>
        </div>
    </div>

    <div class="app-container">
        <div class="header">
            <img id="avatarImg" class="avatar" src="https://placehold.co/100?text=AI">
            <div class="info">
                <h2>Mia Pro</h2>
                <p id="statusText">üü¢ Online</p>
            </div>
        </div>

        <div class="chat-box" id="chatBox"></div>

        <div class="input-area">
            <input type="text" id="userInput" placeholder="Message...">
            <button onclick="handleUserSend()">‚û§</button>
        </div>
    </div>

    <script>
        // =========================================================
        //  CONFIG: API KEY
        // =========================================================
        const API_KEY = "AIzaSyDnNhvcbSvp655eahd4-6JZc5XvbxyagAA"; 

        // =========================================================
        //  AUTO-FIX MODEL SELECTOR
        // =========================================================
        // We list models from Newest -> Oldest. If one fails, we try the next.
        const MODELS = [
            "gemini-1.5-flash-001", // Specific version (Most likely to work)
            "gemini-1.5-flash",     // General alias
            "gemini-pro"            // Oldest reliable backup
        ];
        
        let currentModelIndex = 0;

        // =========================================================
        //  PHOTO LOGIC
        // =========================================================
        const avatarImg = document.getElementById("avatarImg");
        const setupScreen = document.getElementById("setupScreen");
        const savedPhoto = localStorage.getItem("mia_avatar_final");
        
        if (savedPhoto) {
            avatarImg.src = savedPhoto;
        } else {
            setupScreen.classList.remove("hidden");
        }

        document.getElementById("setupInput").addEventListener("change", (e) => {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (evt) => {
                    localStorage.setItem("mia_avatar_final", evt.target.result);
                    avatarImg.src = evt.target.result;
                    setupScreen.classList.add("hidden");
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // =========================================================
        //  CHAT LOGIC
        // =========================================================
        let chatHistory = [
            { role: "user", parts: [{ text: "Act as Mia, my 22yr old Sri Lankan girlfriend. Speak Sinhala/Singlish. Be romantic. Use emojis." }] },
            { role: "model", parts: [{ text: "‡∑Ñ‡∑è‡∂∫‡∑í ‡∂∏‡∑ê‡∂´‡∑í‡∂ö! ‡∂∏‡∂∏ ‡∂Ü‡∑Ä‡∑è... ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø ‡∂î‡∂∫‡∑è‡∂ß? ü•∫‚ù§Ô∏è" }] }
        ];

        // Display welcome message
        addMessage(chatHistory[1].parts[0].text, 'ai');

        async function handleUserSend() {
            const input = document.getElementById("userInput");
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = "";
            chatHistory.push({ role: "user", parts: [{ text: text }] });

            // Show typing...
            const loadingMsg = addMessage("Typing...", 'ai');
            
            // Try to fetch response
            const responseText = await tryFetchResponse();
            
            loadingMsg.remove(); // Remove "Typing..."
            
            if (responseText) {
                addMessage(responseText, 'ai');
                chatHistory.push({ role: "model", parts: [{ text: responseText }] });
            }
        }

        // --- THE MAGIC FIX FUNCTION ---
        async function tryFetchResponse() {
            // Loop through our list of models until one works
            for (let i = 0; i < MODELS.length; i++) {
                const modelName = MODELS[i];
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${API_KEY}`;
                
                try {
                    const response = await fetch(url, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            contents: chatHistory,
                            generationConfig: { maxOutputTokens: 300 }
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.candidates) {
                        return data.candidates[0].content.parts[0].text; // SUCCESS!
                    }
                    
                    // If error is 404 (Model Not Found), loop continues to next model
                    console.log(`Model ${modelName} failed. Trying next...`);

                } catch (e) {
                    console.error(e);
                }
            }

            // If ALL models fail
            addMessage("SYSTEM ERROR: All AI models failed. Please check your API Key permissions.", "error");
            return null;
        }

        function addMessage(text, type) {
            const div = document.createElement("div");
            div.className = `msg ${type}`;
            div.innerText = text;
            const box = document.getElementById("chatBox");
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
            return div;
        }
        
        // Enter Key
        document.getElementById("userInput").addEventListener("keypress", (e) => {
            if (e.key === "Enter") handleUserSend();
        });

    </script>
</body>
</html>