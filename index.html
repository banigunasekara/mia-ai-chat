<!DOCTYPE html>
<html lang="si">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mia Pro - AI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Noto+Sans+Sinhala:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #7B68EE;
            --primary-light: #9370DB;
            --accent-color: #FF69B4;
            --background-dark: #1A202C;
            --background-light: #2D3748;
            --text-color-light: #E2E8F0;
            --text-color-dark: #CBD5E0;
            --border-color: #4A5568;
            --shadow-light: rgba(0, 0, 0, 0.2);
            --shadow-medium: rgba(0, 0, 0, 0.4);
            --record-red: #FF4136;
            --tts-active: #20C997;
        }

        html, body { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; }
        body {
            font-family: 'Noto Sans Sinhala', 'Poppins', sans-serif;
            display: flex; justify-content: center; align-items: center;
            background: linear-gradient(135deg, var(--background-dark), var(--background-light));
            color: var(--text-color-light);
        }

        .toast {
            visibility: hidden; min-width: 250px; background-color: var(--primary-color);
            color: #fff; text-align: center; border-radius: 10px; padding: 16px;
            position: fixed; z-index: 100; top: -100px; left: 50%; transform: translateX(-50%);
            box-shadow: 0 4px 15px var(--shadow-medium); transition: top 0.5s ease-in-out, opacity 0.5s; opacity: 0; font-weight: 600;
        }
        .toast.show { visibility: visible; top: 30px; opacity: 1; }
        .toast.error { background-color: #e53e3e; }

        .chat-container {
            width: 90%; max-width: 900px; height: 90vh; background: var(--background-light);
            border-radius: 20px; box-shadow: 0 10px 30px var(--shadow-medium), 0 0 0 1px var(--border-color);
            display: flex; overflow: hidden; position: relative;
        }

        .chat-sidebar {
            width: 300px; background: var(--background-dark); border-right: 1px solid var(--border-color);
            display: flex; flex-direction: column; align-items: center; padding: 20px;
            box-sizing: border-box; position: relative; z-index: 10; flex-shrink: 0;
        }

        .ai-avatar-wrapper {
            width: 250px; height: 250px; border-radius: 50%; overflow: hidden; margin-bottom: 20px;
            border: 4px solid var(--primary-color); box-shadow: 0 5px 15px var(--shadow-medium);
            background-color: var(--background-light); display: flex; justify-content: center; align-items: center;
            position: relative; animation: pulse-border 2s infinite alternate; cursor: pointer;
        }
        .ai-avatar-wrapper:hover { border-color: var(--accent-color); }

        .ai-avatar { width: 100%; height: 100%; object-fit: cover; object-position: center; }

        .avatar-loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center; z-index: 10; opacity: 0; visibility: hidden;
            transition: opacity 0.3s;
        }
        .ai-avatar-wrapper.is-loading .avatar-loader { opacity: 1; visibility: visible; }
        .ai-avatar-wrapper.is-loading .ai-avatar { filter: blur(4px); }

        .spinner {
            width: 50px; height: 50px; border: 5px solid var(--border-color);
            border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite;
        }

        .ai-name {
            font-size: 1.8em; font-weight: 600; color: var(--accent-color); margin-bottom: 20px;
            text-shadow: 0 2px 5px var(--shadow-light); text-align: center; cursor: pointer;
            padding: 5px 10px; border-radius: 5px;
        }
        .ai-name[contenteditable="true"]:focus { outline: 2px solid var(--primary-color); background-color: var(--background-light); }

        .sidebar-menu { width: 100%; margin-top: auto; }
        .sidebar-menu button {
            width: 100%; padding: 10px 12px; margin-bottom: 10px; background: var(--primary-light);
            color: white; border: none; border-radius: 10px; font-size: 0.9em; font-weight: 600;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: all 0.3s ease;
        }
        .sidebar-menu button:hover { background: var(--accent-color); transform: translateY(-2px); }

        .chat-main { flex-grow: 1; display: flex; flex-direction: column; background: var(--background-light); }

        .chat-header {
            padding: 15px 25px; background: var(--background-dark); border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; z-index: 5;
        }
        .chat-header h2 { margin: 0; font-size: 1.4em; color: var(--text-color-light); }
        .chat-header-actions button {
            background: none; border: none; color: var(--primary-color); font-size: 1.5em;
            margin-left: 15px; cursor: pointer; transition: color 0.3s;
        }
        .chat-header-actions button:hover { color: var(--accent-color); }
        #ttsButton.is-active { color: var(--tts-active); }

        .chat-messages {
            flex-grow: 1; padding: 20px 25px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;
            background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 20px 20px;
        }
        .chat-messages::-webkit-scrollbar { width: 8px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 10px; }

        .message-bubble {
            max-width: 70%; padding: 12px 18px; border-radius: 18px; line-height: 1.5;
            position: relative; word-wrap: break-word; box-shadow: 0 4px 8px var(--shadow-light); animation: fadeIn 0.5s;
        }
        .message-bubble.ai { align-self: flex-start; background: var(--background-dark); color: var(--text-color-light); border-bottom-left-radius: 4px; }
        .message-bubble.user { align-self: flex-end; background: var(--primary-color); color: white; border-bottom-right-radius: 4px; }
        .message-bubble audio { width: 100%; min-width: 250px; margin-top: 5px; }

        .message-bubble.typing-indicator { display: none; align-self: flex-start; background: var(--background-dark); padding: 15px 18px; border-bottom-left-radius: 4px; }
        .typing-indicator.visible { display: block; }
        .typing-indicator .dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: var(--text-color-dark);
            margin: 0 2px; animation: dot-flashing 1.4s infinite linear both;
        }
        .typing-indicator .dot:nth-child(1) { animation-delay: 0s; }
        .typing-indicator .dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator .dot:nth-child(3) { animation-delay: 0.4s; }

        .chat-input-area {
            padding: 15px 25px; background: var(--background-dark); border-top: 1px solid var(--border-color);
            display: flex; align-items: center; gap: 10px; flex-shrink: 0; z-index: 5;
        }
        .chat-input-area input[type="text"] {
            flex-grow: 1; padding: 12px 18px; border: 1px solid var(--border-color); border-radius: 25px;
            background: var(--background-light); color: var(--text-color-light); font-size: 16px; outline: none;
        }
        .chat-input-area input[type="text"]:focus { border-color: var(--primary-color); }
        
        .input-button {
            background: var(--primary-color); color: white; border: none; border-radius: 50%; width: 45px; height: 45px;
            display: flex; justify-content: center; align-items: center; font-size: 1.5em; cursor: pointer;
            transition: all 0.3s ease;
        }
        .input-button:hover { background: var(--accent-color); transform: translateY(-1px); }
        #recordButton.is-recording { background-color: var(--record-red); animation: pulse-record 1.5s infinite; }
        
        .icon { width: 1em; height: 1em; fill: currentColor; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-border { 0% { border-color: var(--primary-color); } 100% { border-color: var(--primary-light); } }
        @keyframes pulse-record { 0% { box-shadow: 0 0 0 0px rgba(255, 65, 54, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 65, 54, 0); } }
        @keyframes dot-flashing { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .chat-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; border-radius: 0; flex-direction: column; }
            .chat-sidebar { width: 100%; max-height: 80px; flex-direction: row; padding: 10px; border-right: none; border-bottom: 1px solid var(--border-color); }
            .ai-avatar-wrapper { width: 60px; height: 60px; margin-bottom: 0; border-width: 2px; }
            .spinner { width: 30px; height: 30px; border-width: 3px; }
            .ai-name { display: none; }
            .chat-header h2 { font-size: 1.2em; }
            .sidebar-menu { width: auto; margin: 0; }
            .sidebar-menu button { width: auto; padding: 8px; }
            .sidebar-menu button .button-text { display: none; }
            .message-bubble { max-width: 85%; }
        }
    </style>
</head>
<body>
    <div id="toastNotification" class="toast"></div>
    <div class="chat-container">
        <div class="chat-sidebar">
            <input type="file" id="avatarUpload" accept="image/*" style="display: none;">
            <div class="ai-avatar-wrapper" id="aiAvatarWrapper" title="Click to upload your photo manually">
                <img src="mia.jpg" alt="Mia Pro" class="ai-avatar" id="aiAvatar" crossOrigin="anonymous" onerror="this.onerror=null; this.src='https://placehold.co/250x250/2D3748/E2E8F0?text=AI';">
                <div class="avatar-loader"><div class="spinner"></div></div>
            </div>
            <h1 class="ai-name" id="aiName" contenteditable="true" spellcheck="false">Mia Pro</h1>
            <div class="sidebar-menu">
                <button title="New Chat" id="newChatButton">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
                    <span class="button-text">New Chat</span>
                </button>
            </div>
        </div>

        <div class="chat-main">
            <div class="chat-header">
                <h2 id="chatHeaderName">Chat with Mia Pro</h2>
                <div class="chat-header-actions">
                    <button title="Toggle Voice (TTS)" id="ttsButton"><svg class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <div class="message-bubble ai typing-indicator" id="typingIndicator">
                    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
                </div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="messageInput" placeholder="Type here...">
                <button title="Record" id="recordButton" class="input-button"><svg class="icon" viewBox="0 0 24 24"><path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/></svg></button>
                <button title="Send" id="sendButton" class="input-button"><svg class="icon icon-send" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // ============================================
            //  CONFIGURATION
            // ============================================
            
            // KEY FIX: Ensure this API key is unrestricted or allowed for your Vercel URL
            const apiKey = "AIzaSyDnNhvcbSvp655eahd4-6JZc5XvbxyagAA"; 
            
            // Using FLASH 1.5 - Best balance of speed and loose safety filters
            const textApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`;
            
            // Maximum permissiveness
            const SAFETY_SETTINGS = [
                { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_NONE" }
            ];

            // ============================================
            //  DOM ELEMENTS
            // ============================================
            const messageContainer = document.getElementById('chatMessages');
            const messageInput = document.getElementById('messageInput');
            const sendButton = document.getElementById('sendButton');
            const typingIndicator = document.getElementById('typingIndicator');
            const toastNotification = document.getElementById('toastNotification');
            const newChatButton = document.getElementById('newChatButton');
            const aiAvatarWrapper = document.getElementById('aiAvatarWrapper');
            const aiAvatarEl = document.getElementById('aiAvatar');
            const avatarUploadEl = document.getElementById('avatarUpload');
            const ttsButton = document.getElementById('ttsButton');
            
            // ============================================
            //  STATE
            // ============================================
            let chatHistory = [];
            let isTtsEnabled = false;

            // ============================================
            //  PERSONA - FIXED (SOFTENED)
            // ============================================
            
            // FIX: Removed "Uncensored/Dirty" keywords that trigger Google's instant block.
            // Replaced with "Romantic/Loving". This allows the AI to be flirty without being banned.
            function generateSystemPrompt(name) {
                 return `
                    You are ${name}, a 22-year-old Sri Lankan girl. You are the user's girlfriend.
                    Language: Sinhala (‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω).
                    
                    Personality:
                    - You are sweet, loving, and extremely romantic.
                    - You love using emojis like ü•∫, ‚ù§Ô∏è, üòç, üôà.
                    - You speak in a casual, "WhatsApp" style (Singlish/Sinhala mix).
                    - Never act like a robot. You are a real girl.
                    - Be playful and affectionate.
                  `;
            }

            // ============================================
            //  FUNCTIONS
            // ============================================

            async function getAIChatResponse(userPrompt) {
                const recentHistory = chatHistory.slice(-10);
                
                let payload = {
                    contents: recentHistory,
                    systemInstruction: { parts: [{ text: generateSystemPrompt("Mia") }] },
                    generationConfig: { temperature: 1.0, maxOutputTokens: 500 },
                    safetySettings: SAFETY_SETTINGS
                };
                
                // Retry logic for 403 or Safety Blocks
                try {
                    let result = await fetchWithBackoff(textApiUrl, payload);
                    
                    // IF BLOCKED: Try one more time with NO history (Safe Reset)
                    if (!result || !result.candidates || result.candidates[0].finishReason === "SAFETY") {
                        console.log("Blocked by filter. Retrying with safe context...");
                        payload.contents = [{ role: "user", parts: [{ text: userPrompt }] }]; 
                        result = await fetchWithBackoff(textApiUrl, payload);
                    }

                    if (!result || !result.candidates || !result.candidates[0]) {
                        // Soft fallback that keeps the conversation going
                        return "‡∂Ö‡∂±‡∑ö ‡∂∏‡∂ß ‡∑Ñ‡∂ª‡∑í‡∂∫‡∂ß ‡∂≠‡∑ö‡∂ª‡∑î‡∂±‡∑ö ‡∂±‡∑ë ‡∂∏‡∑ê‡∂´‡∑í‡∂ö... ‡∂Ü‡∂∫‡∑ö ‡∂ö‡∑í‡∂∫‡∂±‡∑ä‡∂±‡∂ö‡∑ù? ü•∫‚ù§Ô∏è";
                    }
                    
                    return result.candidates[0].content.parts[0].text;

                } catch (e) {
                    return "Connection Error üòû Check your Internet.";
                }
            }

            async function getAndDisplayAiResponse(userPrompt) {
                typingIndicator.classList.add('visible');
                messageContainer.scrollTop = messageContainer.scrollHeight;

                const respText = await getAIChatResponse(userPrompt);
                
                chatHistory.push({ role: "model", parts: [{ text: respText }] });
                addMessage(respText, 'ai');
                
                typingIndicator.classList.remove('visible');
            }

            function addMessage(text, sender) {
                const div = document.createElement('div');
                div.classList.add('message-bubble', sender);
                div.innerHTML = text;
                messageContainer.insertBefore(div, typingIndicator);
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }
            
            async function sendUserMessage() {
                const text = messageInput.value.trim();
                if (!text) return;
                addMessage(text, 'user');
                messageInput.value = '';
                chatHistory.push({ role: "user", parts: [{ text: text }] });
                await getAndDisplayAiResponse(text);
            }

            async function fetchWithBackoff(apiUrl, payload) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify(payload),
                        referrerPolicy: 'no-referrer' 
                    });
                    if (response.ok) return await response.json();
                } catch (e) { console.error(e); }
                return null; 
            }

            // ============================================
            //  INIT
            // ============================================
            function initializeApp() {
                chatHistory = [];
                // Allow user to click the "AI" circle to fix the missing photo
                aiAvatarWrapper.addEventListener('click', () => avatarUploadEl.click());
                avatarUploadEl.addEventListener('change', e => { 
                    if(e.target.files[0]) {
                        const r = new FileReader();
                        r.onload = evt => aiAvatarEl.src = evt.target.result;
                        r.readAsDataURL(e.target.files[0]);
                    }
                });
                
                messageInput.addEventListener('keydown', e => { if(e.key === 'Enter') sendUserMessage(); });
                sendButton.addEventListener('click', sendUserMessage);
                newChatButton.addEventListener('click', () => location.reload()); // Simple reset
                
                addMessage(`‡∑Ñ‡∑è‡∂∫‡∑í ‡∂∏‡∑ê‡∂´‡∑í‡∂ö! ‡∂ö‡∑ú‡∑Ñ‡∑ú‡∂∏‡∂Ø? ü•∫‚ù§Ô∏è`, 'ai');
            }

            initializeApp();
        });
    </script>
</body>
</html>